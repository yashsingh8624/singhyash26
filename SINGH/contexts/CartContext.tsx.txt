import AsyncStorage from '@react-native-async-storage/async-storage';
import createContextHook from '@nkzw/create-context-hook';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useState, useEffect, useCallback } from 'react';

import { CartItem, Product, Size } from '@/types';

const CART_STORAGE_KEY = '@cart';

export const [CartContext, useCart] = createContextHook(() => {
  const [cart, setCart] = useState<CartItem[]>([]);
  const queryClient = useQueryClient();

  const cartQuery = useQuery({
    queryKey: ['cart'],
    queryFn: async () => {
      const stored = await AsyncStorage.getItem(CART_STORAGE_KEY);
      return stored ? JSON.parse(stored) : [];
    },
  });

  const syncMutation = useMutation({
    mutationFn: async (items: CartItem[]) => {
      await AsyncStorage.setItem(CART_STORAGE_KEY, JSON.stringify(items));
      return items;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['cart'] });
    },
  });

  const { mutate: syncCart } = syncMutation;

  useEffect(() => {
    if (cartQuery.data) {
      setCart(cartQuery.data);
    }
  }, [cartQuery.data]);

  const addToCart = useCallback(
    (product: Product, size: Size, color: string, quantity: number = 1) => {
      const existingItemIndex = cart.findIndex(
        (item) =>
          item.product.id === product.id &&
          item.size === size &&
          item.color === color,
      );

      let updatedCart: CartItem[];
      if (existingItemIndex >= 0) {
        updatedCart = cart.map((item, index) =>
          index === existingItemIndex
            ? { ...item, quantity: item.quantity + quantity }
            : item,
        );
      } else {
        updatedCart = [...cart, { product, size, color, quantity }];
      }

      setCart(updatedCart);
      syncCart(updatedCart);
    },
    [cart, syncCart],
  );

  const updateQuantity = useCallback(
    (productId: string, size: Size, color: string, quantity: number) => {
      const updatedCart = cart
        .map((item) =>
          item.product.id === productId &&
          item.size === size &&
          item.color === color
            ? { ...item, quantity }
            : item,
        )
        .filter((item) => item.quantity > 0);

      setCart(updatedCart);
      syncCart(updatedCart);
    },
    [cart, syncCart],
  );

  const removeFromCart = useCallback(
    (productId: string, size: Size, color: string) => {
      const updatedCart = cart.filter(
        (item) =>
          !(
            item.product.id === productId &&
            item.size === size &&
            item.color === color
          ),
      );

      setCart(updatedCart);
      syncCart(updatedCart);
    },
    [cart, syncCart],
  );

  const clearCart = useCallback(() => {
    setCart([]);
    syncCart([]);
  }, [syncCart]);

  const total = cart.reduce((sum, item) => {
    const price = item.product.discount
      ? item.product.price * (1 - item.product.discount / 100)
      : item.product.price;
    return sum + price * item.quantity;
  }, 0);

  const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);

  return {
    cart,
    addToCart,
    updateQuantity,
    removeFromCart,
    clearCart,
    total,
    itemCount,
    isLoading: cartQuery.isLoading,
  };
});
